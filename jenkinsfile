pipeline {
  agent any 
  environment {
		DOCKERHUB_CREDENTIALS=credentials('ram-dockerhub-login')
	}
    stages {
      stage('SonarQube analysis') {
        environment{
               scannerHome = tool 'sonar-scanner'
          }
        steps { 
          withSonarQubeEnv('sonarqube') {
            sh "${scannerHome}/bin/sonar-scanner"     
           }
        }
     } 
      stage("Quality Gate") {
            steps {
              timeout(time: 10, unit: 'MINUTES') {
                waitForQualityGate abortPipeline: true
              }
            }
          }
      stage("Create Docker image") {
      steps {
      withCredentials([usernamePassword(credentialsId: 'nexus-secret', passwordVariable: 'pass', usernameVariable: 'username')]) {
      
              sh '''
                sudo docker build -t 35.232.16.59:8082/appointme-admin-api:${BUILD_NUMBER} .
                sudo docker login -u ${username} -p ${pass} 35.232.16.59:8082
                sudo docker push 35.232.16.59:8082/appointme-admin-api:${BUILD_NUMBER} 
                
                '''
		}
            }

   }
   
   stage("Trivy Docker scan") 
   {
            steps {
              sh "sudo trivy image 35.232.16.59:8082/appointme-admin-api:${BUILD_NUMBER}"
 
                  }
    }

 }
}

