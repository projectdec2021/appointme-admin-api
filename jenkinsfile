pipeline {
  agent any 
  environment {
		DOCKERHUB_CREDENTIALS=credentials('ram-dockerhub-login')
		TRIVY_CRITICAL_THRES=200
		DOCK_IMG_NAME="34.136.48.223:8082/appointme-admin-api:${BUILD_NUMBER}"
		date_format = new Date().format('dd-MM-yy-HHmm')
		
	      }
    stages {
      stage('SonarQube analysis') {
        environment{
               scannerHome = tool 'sonar-scanner'
          }
        steps { 
          withSonarQubeEnv('sonarqube') {
            sh "${scannerHome}/bin/sonar-scanner"     
           }
        }
     } 
      stage("Quality Gate") {
            steps {
              timeout(time: 10, unit: 'MINUTES') {
                waitForQualityGate abortPipeline: true
              }
            }
          }
      stage("Create Docker image") {
      steps {
      withCredentials([usernamePassword(credentialsId: 'nexus-secret', passwordVariable: 'pass', usernameVariable: 'username')]) {
      
              sh '''
                sudo docker build -t ${DOCK_IMG_NAME} .
                sudo docker login -u ${username} -p ${pass} 34.136.48.223:8082
                sudo docker push ${DOCK_IMG_NAME}
                
                '''
		}
            }

   }
   
   stage("Trivy Docker scan") 
   {
            steps {
              sh '''
	      TH=`sudo trivy image ${DOCK_IMG_NAME} |sed -n '8,8p'|cut -d ":" -f7|cut -d ")" -f1`
	      if [ -z "${TH}" ] || [ $TH -gt ${TRIVY_CRITICAL_THRES} ]
	      then   
	         echo "FAILED:Critical: "${TH} " has Crossed the Critical Threshold Limit of "${TRIVY_CRITICAL_THRES} !!!!!
		 exit 1
	      fi
	      
	      '''
 
                  }
    }
    
    stage('Deploy Application') 
    {
      when {
                expression {
                    !env.GIT_BRANCH.contains("main")
                           }
            }
      steps { 
                
	      /* withCredentials([kubeconfigContent(credentialsId: 'kubernetes-ram', variable: 'KUBECONFIG_CONTENT')])  */
	      withCredentials([kubeconfigFile(credentialsId: 'kubeconfig-cred', variable: 'KUBECONFIG')]) 
	      {
	        sh '''
		datree config set token ad6dfafb-9ff1-44c5-a175-8bba5e1d16a7
		helm datree test helm
		helm upgrade --install --set image.repository=${DOCK_IMG_NAME} --set image.tag="${date_format}" appoint-admin-api helm/'
		'''
              }
            }
     }
 }
}
